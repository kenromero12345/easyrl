<!doctype html>
<html lang="en">
    <head>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
              integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
        <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/styles.css') }}">
        <script type=text/javascript src="{{  url_for('static', filename='js/model.js') }}"></script>
        <script type=text/javascript src="{{  url_for('static', filename='js/combined.js') }}"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <title>EasyRL</title>
    </head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid">
                <a class="navbar-brand" href="/index">EasyRL</a>
                <button
                        class="navbar-toggler"
                        type="button"
                        data-mdb-toggle="collapse"
                        data-mdb-target="#navbarNavAltMarkup"
                        aria-controls="navbarNavAltMarkup"
                        aria-expanded="false"
                        aria-label="Toggle navigation"
                >
                    <i class="fas fa-bars"></i>
                </button>
                <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                    <div class="navbar-nav">
                        <a class="nav-link active" aria-current="page" href="/index">Model</a>
                        <a class="nav-link" href="/about">About</a>
                        <a class="nav-link" href="/help">Help</a>
                    </div>
                </div>
            </div>
        </nav>

        <div class="topBtn">
            <button type="button" class="btn btn-secondary btn-lg btn-block, modelButtons" onclick="train()">
                Train</button>
            <button type="button" class="btn btn-secondary btn-lg btn-block, modelButtons" onclick="halt()">
                Halt</button>
            <button type="button" class="btn btn-secondary btn-lg btn-block, modelButtons" onclick="test()">
                Test</button>
            <button type="button" class="btn btn-secondary btn-lg btn-block, modelButtons" onclick="reset()">
                Reset</button>
            <button type="button" class="btn btn-secondary btn-lg btn-block, modelButtons"
                    onClick="makeLoadVisible(this)">Load Model</button>
            <input class="form-control" type="file"/>
            <button type="button" class="btn btn-primary btn-lg btn-block, loadBtn" onClick="loadModel(this)">Upload</button>
            <button type="button" class="btn btn-secondary btn-lg btn-block, modelButtons"
                    onClick="makeSaveComponentsVisible(this);">Save Model</button>
            <input type="text" class="form-control, saveName" placeholder="filename" aria-label="filename"
                   aria-describedby="basic-addon1">
            <button type="button" class="btn btn-primary btn-lg btn-block, saveNameBtn"
                    onClick="saveModel(this)">Download</button>

            <button type="button" class="btn btn-secondary btn-lg btn-block, modelButtons"
                    onClick="makeSaveComponentsVisible(this);">Save Results</button>
            <input type="text" class="form-control, saveName" placeholder="filename" aria-label="filename"
                   aria-describedby="basic-addon1">
            <button type="button" class="btn btn-primary btn-lg btn-block, saveNameBtn"
                    onClick="saveResults(this)">Download</button>
        </div>

        <div class="modelLeft">
            {% for p in params %}
            <div class="hyperparameters">
                <label for="{{p.name}} range" class="form-label">{{p.name}}</label>
                <div class="hyperparameter">
                    <input type="range" class="form-range" id="{{p.name}} range" min={{p.min}} max={{p.max}}
                           value={{p.default}} step={{p.resolution}} onchange="updateSlider(this)">
                    <input class="form-control, customInput" type="number" id="{{p.name}} number" value={{p.default}}
                           onchange="updateInput(this)">
                </div>
            </div>
            <br>
            {% endfor %}

        </div>
        <div class="modelRight">
            <div id="chartContainer"></div>
            <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
            <div>
                    <label id="totalTrainingRewardLbl">Total Training Reward: </label>
                    <label id="totalTrainingReward">0</label>
                    <label id="rewardPerEpisodeLbl">Reward/Episode: </label>
                    <label id="rewardPerEpisode">0</label>
            </div>
            <img class="modelImg" src="{{ url_for('static',filename='img/tempEnv.png') }}"/>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
                integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
                crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
                integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
                crossorigin="anonymous"></script>

        <script>
            var dpsLoss = []; // dataPoints
            var dpsReward = [];
            var dpsEpsilon = [];
            var chart;
            var xVal = 1;
            var isRunning = false;
            var chart = null;
            var isReset = false;
            var totalTrainingReward = document.querySelector("#totalTrainingReward");
            var rewardPerEpisode = document.querySelector("#rewardPerEpisode");
            var totalTrainingRewardVal = 0;

            window.onload = function () {
                chart = createChart();
                chart.render();
            }

            function createChart() {
                var chart = new CanvasJS.Chart("chartContainer", {
                    title :{
                        text: "Dynamic Data"
                    },
                    legend: {
                        cursor: "pointer",
                        itemclick: toggleDataSeries
                    },
                    toolTip: {
                        shared: true
                    },
                    axisY:[{
                        title: "Reward",
                        lineColor: "green",
                        tickColor: "green",
                        labelFontColor: "green",
                        titleFontColor: "green",
                        includeZero: true,
                    },
                    {
                        title: "MSE Episode Loss",
                        lineColor: "red",
                        tickColor: "red",
                        labelFontColor: "red",
                        titleFontColor: "red",
                        includeZero: true,
                    },
                    {
                        title: "Epsilon",
                        lineColor: "blue",
                        tickColor: "blue",
                        labelFontColor: "blue",
                        titleFontColor: "blue",
                        includeZero: true,
                    }],
                    data: [{
                        type: "line",
                        name: "MSE Episode Loss",
                        dataPoints: dpsLoss,
                        showInLegend: true,
                        axisYIndex: 1,
                        color: "red",
                    }, {
                        type: "line",
                        name: "Reward",
                        dataPoints: dpsReward,
                        showInLegend: true,
                        axisYIndex: 0,
                        color: "green",
                    }, {
                        type: "line",
                        name: "Epsilon",
                        dataPoints: dpsEpsilon,
                        showInLegend: true,
                        axisYIndex: 2,
                        color: "blue",
                    }],
                    exportEnabled: true,
                    width: 600,
                    height:250,
                });
                return chart;
            }

            function toggleDataSeries(e) {
                if (typeof (e.dataSeries.visible) === "undefined" || e.dataSeries.visible) {
                    e.dataSeries.visible = false;
                } else {
                    e.dataSeries.visible = true;
                }
                e.chart.render();
            }

            function reset() {
                $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
                console.log("resetting")
                console.log(isRunning)
                if (isRunning) {
                    console.log("about to reset")
                    isRunning = false;
                    isReset = true;
                } else {
                    console.log("reset")
                    chartReset();
                }
                $.getJSON($SCRIPT_ROOT + '/reset');
            }

            function halt() {
                $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
                isRunning = false;
                $.getJSON($SCRIPT_ROOT + '/halt')
            }

            function chartReset() {
                dpsLoss = []
                dpsReward = []
                dpsEpsilon = []
                xVal = 1;
                chart = createChart()
                chart.render()
                totalTrainingRewardVal = 0
                totalTrainingReward.innerHTML = 0
                rewardPerEpisode.innerHTML = 0
            }

            function train() {
                if (!isRunning) {
                    isRunning = true;
                    chartReset()
                    var lists = document.querySelectorAll("input[type=range]");
                    var params = {}
                    for (var i = 0; i < lists.length; i++) {
                        params[i] = lists[i].value;
                    }
                    $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
                    $.getJSON($SCRIPT_ROOT + '/startTrain', params, function(data) {
                        trainRecursion()
                    });
                }
            }

            function trainRecursion() {
                $.getJSON($SCRIPT_ROOT + '/runTrain', function(data) {
                    if (data.finished) {
                        isRunning = false
                    } else {
                        if (isReset) {
                            isRunning = false
                            isReset = false
                            chartReset()
                        } else {
                            chartLossAdd(xVal, data.loss)
                            chartRewardAdd(xVal, data.reward)
                            chartEpsilonAdd(xVal, data.epsilon)
                            xVal++;
                            chart.render();
                            trainRecursion()
                            totalTrainingRewardVal += data.reward
                            totalTrainingReward.innerHTML = totalTrainingRewardVal
                            rewardPerEpisode.innerHTML = (totalTrainingRewardVal/xVal).toFixed(4)
                        }
                    }
                });
            }

            function chartLossAdd(index, loss) {
                dpsLoss.push({
                    x: index,
                    y: loss
                });
            }

            function chartRewardAdd(index, reward) {
                dpsReward.push({
                    x: index,
                    y: reward
                });
            }

            function chartEpsilonAdd(index, epsilon) {
                dpsEpsilon.push({
                    x: index,
                    y: epsilon
                });
            }

            function saveResults(btn) {
                input = btn.previousElementSibling;
                var results = "";
                for(var i = 0; i < dpsLoss.length; i++) {
                    results += (i+1) + ", " + dpsLoss[i].y + ", " + dpsReward[i].y + ", " + dpsEpsilon[i].y + "\n";
                }
                download(results, input.value, "txt")
                input.style.display = "none";
                btn.style.display = "none";
                input.value = "";
            }

            function saveModel(btn) {
                input = btn.previousElementSibling;
                $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
                $.getJSON($SCRIPT_ROOT + '/saveModel', function(data) {
                    download(data.agent, input.value, "txt")
                    input.style.display = "none";
                    btn.style.display = "none";
                    input.value = "";
                });
            }

            function loadModel(btn) {
                input = btn.previousElementSibling
                input.style.display = "none";
                btn.style.display = "none";
                $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
                var fr = new FileReader();
                var temp;
                fr.onload=function(){
                    temp = fr.result;
                    $.getJSON($SCRIPT_ROOT + '/loadModel', {
                        agent: temp
                    }, function(data) {
                        if (data.success) {
                            window.alert("Model Uploaded");
                        } else {
                            window.alert("Incorrect Model! Loading Unsuccessful");
                        }
                        input.style.display = "none";
                        btn.style.display = "none";
                        input.value = "";
                    });
                }
                fr.readAsText(input.files[0]);
            }

        </script>
    </body>
</html>