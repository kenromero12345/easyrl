<!doctype html>
<html lang="en">
    <head>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
              integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
        <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/styles.css') }}">
        <script type=text/javascript src="{{  url_for('static', filename='js/model.js') }}"></script>
        <script type=text/javascript src="{{  url_for('static', filename='js/combined.js') }}"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <title>EasyRL</title>
    </head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid">
                <a class="navbar-brand" href="/index">EasyRL</a>
                <button
                        class="navbar-toggler"
                        type="button"
                        data-mdb-toggle="collapse"
                        data-mdb-target="#navbarNavAltMarkup"
                        aria-controls="navbarNavAltMarkup"
                        aria-expanded="false"
                        aria-label="Toggle navigation"
                >
                    <i class="fas fa-bars"></i>
                </button>
                <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                    <div class="navbar-nav">
                        <a class="nav-link active" aria-current="page" href="/index">Model</a>
                        <a class="nav-link" href="/about">About</a>
                        <a class="nav-link" href="/help">Help</a>
                    </div>
                </div>
            </div>
        </nav>

        <div class="topBtn">
            <button type="button" class="btn btn-secondary btn-lg btn-block, modelButtons" onclick="train()">
                Train</button>
            <button type="button" class="btn btn-secondary btn-lg btn-block, modelButtons" onclick="halt()">
                Halt</button>
            <button type="button" class="btn btn-secondary btn-lg btn-block, modelButtons" onclick="test()">
                Test</button>
            <button type="button" class="btn btn-secondary btn-lg btn-block, modelButtons" onclick="reset()">
                Reset</button>
            <!--      onclick="window.location.href='/index';"-->
            <button type="button" class="btn btn-secondary btn-lg btn-block, modelButtons"
                    onClick="makeLoadVisible(this)">Load Model</button>
            <input class="form-control" type="file" onchange="load()"/>
            <button type="button" class="btn btn-primary btn-lg btn-block, loadBtn" onClick="load(this)">Upload</button>
            <button type="button" class="btn btn-secondary btn-lg btn-block, modelButtons"
                    onClick="makeSaveComponentsVisible(this);">Save Model</button>
            <input type="text" class="form-control, saveName" placeholder="filename" aria-label="filename"
                   aria-describedby="basic-addon1">
            <button type="button" class="btn btn-primary btn-lg btn-block, saveNameBtn"
                    onClick="save(this)">Download</button>

            <button type="button" class="btn btn-secondary btn-lg btn-block, modelButtons"
                    onClick="makeSaveComponentsVisible(this);">Save Results</button>
            <input type="text" class="form-control, saveName" placeholder="filename" aria-label="filename"
                   aria-describedby="basic-addon1">
            <button type="button" class="btn btn-primary btn-lg btn-block, saveNameBtn"
                    onClick="save(this)">Download</button>
        </div>

        <div class="modelLeft">
            {% for p in params %}
            <div class="hyperparameters">
                <label for="{{p.name}} range" class="form-label">{{p.name}}</label>
                <div class="hyperparameter">
                    <input type="range" class="form-range" id="{{p.name}} range" min={{p.min}} max={{p.max}}
                           value={{p.default}} step={{p.resolution}} onchange="updateSlider(this)">
                    <input class="form-control, customInput" type="number" id="{{p.name}} number" value={{p.default}}
                           onchange="updateInput(this)">
                </div>
            </div>
            <br>
            {% endfor %}
<!--            <div class="hyperparameters">-->
<!--                <label for="customRange1" class="form-label">Number of Episodes</label>-->
<!--                <div class="hyperparameter">-->
<!--                    <input type="range" class="form-range" id="customRange1" min=0 max=100 value=1-->
<!--                           onchange="updateSlider(this)">-->
<!--                    <input class="form-control, customInput" type="number" id="customInput1" value=1-->
<!--                           onchange="updateInput(this)">-->
<!--                </div>-->
<!--            </div>-->
<!--            <br>-->
<!--            <div class="hyperparameters">-->
<!--                <label for="customRange2" class="form-label">rangelong 2</label>-->
<!--                <div class="hyperparameter">-->
<!--                    <input type="range" class="form-range" id="customRange2" min=0 max=100 value=1-->
<!--                           onchange="updateSlider(this)">-->
<!--                    <input class="form-control, customInput" type="number" id="customInput2" value=1-->
<!--                           onchange="updateInput(this)">-->
<!--                </div>-->
<!--            </div>-->
<!--            <br>-->
<!--            <div class="hyperparameters">-->
<!--                <label for="customRange3" class="form-label">rangelonglong 3</label>-->
<!--                <div class="hyperparameter">-->
<!--                    <input type="range" class="form-range" id="customRange3" min=0 max=100 value=1-->
<!--                           onchange="updateSlider(this)">-->
<!--                    <input class="form-control, customInput" type="number" id="customInput3" value=1-->
<!--                           onchange="updateInput(this)">-->
<!--                </div>-->
<!--            </div>-->

        </div>
        <div class="modelRight">
            <div id="chartContainer"></div>
            <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
            <img class="modelImg" src="{{ url_for('static',filename='img/tempEnv.png') }}"/>
        </div>

<!--        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"-->
<!--                integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"-->
<!--                crossorigin="anonymous"></script>-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
                integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
                crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
                integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
                crossorigin="anonymous"></script>

        <script>
            var dpsLoss = []; // dataPoints
            var dpsReward = []
            var dpsEpsilon = []
            var chart;
            var xVal = 0;
            var isRunning = false
            var chart = null;
            var isReset = false
            window.onload = function () {
                chart = createChart()

<!--                //chart-->


<!--                chart = new CanvasJS.Chart("chartContainer", {-->
<!--                    title :{-->
<!--                        text: "Dynamic Data"-->
<!--                    },-->
<!--                    legend: {-->
<!--                        cursor: "pointer",-->
<!--                        itemclick: toggleDataSeries-->
<!--                    },-->
<!--                    toolTip: {-->
<!--                        shared: true-->
<!--                    },-->
<!--                    axisY:[{-->
<!--                        title: "MSE Episode Loss",-->
<!--                        lineColor: "red",-->
<!--                        tickColor: "red",-->
<!--                        labelFontColor: "red",-->
<!--                        titleFontColor: "red",-->
<!--                        includeZero: true,-->
<!--                    },-->
<!--                    {-->
<!--                        title: "Reward",-->
<!--                        lineColor: "green",-->
<!--                        tickColor: "green",-->
<!--                        labelFontColor: "green",-->
<!--                        titleFontColor: "green",-->
<!--                        includeZero: true,-->
<!--                    },-->
<!--                    {-->
<!--                        title: "Epsilon",-->
<!--                        lineColor: "blue",-->
<!--                        tickColor: "blue",-->
<!--                        labelFontColor: "blue",-->
<!--                        titleFontColor: "blue",-->
<!--                        includeZero: true,-->
<!--                    }],-->
<!--                    data: [{-->
<!--                        type: "line",-->
<!--                        name: "MSE Episode Loss",-->
<!--                        dataPoints: dpsLoss,-->
<!--                        showInLegend: true,-->
<!--                        axisYIndex: 1,-->
<!--                        color: "red",-->
<!--                    }, {-->
<!--                        type: "line",-->
<!--                        name: "Reward",-->
<!--                        dataPoints: dpsReward,-->
<!--                        showInLegend: true,-->
<!--                        axisYIndex: 0,-->
<!--                        color: "green",-->
<!--                    }, {-->
<!--                        type: "line",-->
<!--                        name: "Epsilon",-->
<!--                        dataPoints: dpsEpsilon,-->
<!--                        showInLegend: true,-->
<!--                        axisYIndex: 2,-->
<!--                        color: "blue",-->
<!--                    }],-->
<!--                    exportEnabled: true,-->
<!--                    width: 600,-->
<!--                    height:250,-->
<!--                });-->

<!--&lt;!&ndash;                var xVal = 0;&ndash;&gt;-->
<!--&lt;!&ndash;                var yVal = 100;&ndash;&gt;-->
<!--                var updateInterval = 100;-->
<!--                var dataLength = 20; // number of dataPoints visible at any point-->

<!--&lt;!&ndash;                var updateChart = function (count) {&ndash;&gt;-->

<!--&lt;!&ndash;                    count = count || 1;&ndash;&gt;-->

<!--&lt;!&ndash;                    for (var j = 0; j < count; j++) {&ndash;&gt;-->
<!--&lt;!&ndash;                        yVal = yVal +  Math.round(5 + Math.random() *(-5-5));&ndash;&gt;-->
<!--&lt;!&ndash;                        dps.push({&ndash;&gt;-->
<!--&lt;!&ndash;                            x: xVal,&ndash;&gt;-->
<!--&lt;!&ndash;                            y: yVal&ndash;&gt;-->
<!--&lt;!&ndash;                        });&ndash;&gt;-->
<!--&lt;!&ndash;                        xVal++;&ndash;&gt;-->
<!--&lt;!&ndash;                  }&ndash;&gt;-->

<!--&lt;!&ndash;            //        if (dps.length > dataLength) {&ndash;&gt;-->
<!--&lt;!&ndash;            //          dps.shift();&ndash;&gt;-->
<!--&lt;!&ndash;            //        }&ndash;&gt;-->


<!--&lt;!&ndash;            };&ndash;&gt;-->
<!--            chart.render();-->
<!--&lt;!&ndash;            updateChart(dataLength);&ndash;&gt;-->
<!--&lt;!&ndash;            setInterval(function(){updateChart()}, updateInterval);&ndash;&gt;-->


<!--            //TODO: use the parameters <agent> and <environment>-->

            }

            function createChart() {
                var chart = new CanvasJS.Chart("chartContainer", {
                    title :{
                        text: "Dynamic Data"
                    },
                    legend: {
                        cursor: "pointer",
                        itemclick: toggleDataSeries
                    },
                    toolTip: {
                        shared: true
                    },
                    axisY:[{
                        title: "MSE Episode Loss",
                        lineColor: "red",
                        tickColor: "red",
                        labelFontColor: "red",
                        titleFontColor: "red",
                        includeZero: true,
                    },
                    {
                        title: "Reward",
                        lineColor: "green",
                        tickColor: "green",
                        labelFontColor: "green",
                        titleFontColor: "green",
                        includeZero: true,
                    },
                    {
                        title: "Epsilon",
                        lineColor: "blue",
                        tickColor: "blue",
                        labelFontColor: "blue",
                        titleFontColor: "blue",
                        includeZero: true,
                    }],
                    data: [{
                        type: "line",
                        name: "MSE Episode Loss",
                        dataPoints: dpsLoss,
                        showInLegend: true,
                        axisYIndex: 1,
                        color: "red",
                    }, {
                        type: "line",
                        name: "Reward",
                        dataPoints: dpsReward,
                        showInLegend: true,
                        axisYIndex: 0,
                        color: "green",
                    }, {
                        type: "line",
                        name: "Epsilon",
                        dataPoints: dpsEpsilon,
                        showInLegend: true,
                        axisYIndex: 2,
                        color: "blue",
                    }],
                    exportEnabled: true,
                    width: 600,
                    height:250,
                });
                chart.render()
                return chart
            }

            function toggleDataSeries(e) {
                if (typeof (e.dataSeries.visible) === "undefined" || e.dataSeries.visible) {
                    e.dataSeries.visible = false;
                } else {
                    e.dataSeries.visible = true;
                }
                e.chart.render();
            }

            function reset() {
                $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
                isRunning = false;
                $.getJSON($SCRIPT_ROOT + '/reset')
                isReset = true;
            }

            function halt() {
                $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
                isRunning = false;
<!--                console.log("halt")-->
                $.getJSON($SCRIPT_ROOT + '/halt')
            }

            function chartReset() {
                dpsLoss = []
                dpsReward = []
                dpsEpsilon = []
                xVal = 0
                chart = createChart()
            }

            function train() {
                var lists = document.querySelectorAll("input[type=range]");
                var params = {}
                for (var i = 0; i < lists.length; i++) {
                    params[i] = lists[i].value;
                }
<!--                console.log(params)-->
                $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
                $.getJSON($SCRIPT_ROOT + '/startTrain', params, function(data) {
                    isRunning = true;
                    var episodes = data.episodes;
<!--                    console.log(episodes)-->
                    for (i = 0; i < episodes  && isRunning; i++) {
                        console.log(isRunning)
                        $.getJSON($SCRIPT_ROOT + '/runTrain', {
                        }, function(data) {
                            console.log(data.loss)
                            dpsLoss.push({
                                x: xVal,
                                y: data.loss
                            });
                            dpsReward.push({
                                x: xVal,
                                y: data.reward
                            });
                            dpsEpsilon.push({
                                x: xVal,
                                y: data.epsilon
                            });
                            xVal++;
                            chart.render();
                        });
                    }
                    if (isReset) {
                        chartReset()
                        isReset = false
                    }

                    isRunning = false;
                });
<!--                $.ajax({-->
<!--                      type: "GET",-->
<!--                      url: $SCRIPT_ROOT + '/startTrain',-->
<!--                      data: {params,-->
<!--                      success: function (result) {-->
<!--                           // do something here-->
<!--                      }-->
<!--                 });-->
            }
        </script>
    </body>

</html>